---
name: bits-service
templates:
  bits-service_ctl.erb:    bin/bits-service_ctl
  nginx_ctl.erb:           bin/nginx_ctl
  blobstore_waiter.sh.erb: bin/blobstore_waiter.sh
  dns_health_check.erb:    bin/dns_health_check
  signer_ctl.sh.erb:       bin/signer_ctl

  nginx.conf.erb:             config/nginx.conf
  bits_config.yml.erb:        config/bits_config.yml
  signer_users.erb:           config/signer_users
  app_stash_ca_cert.pem.erb:  config/certs/app_stash_ca_cert.pem
  buildpacks_ca_cert.pem.erb: config/certs/buildpacks_ca_cert.pem
  droplets_ca_cert.pem.erb:   config/certs/droplets_ca_cert.pem
  packages_ca_cert.pem.erb:   config/certs/packages_ca_cert.pem

packages:
  - ruby-2.3
  - bits-service
  - bits-common
  - nginx
  - bits_url_signer

properties:
  system_domain:
    description: "The system domain.  The public server will listen on host 'bits-service.system-domain.tld'"

  request_timeout_in_seconds:
    description: "Timeout for requests in seconds."
    default: 900

  bits-service.secret:
    description: "The secret used for signing URLs"
  bits-service.signer_users:
    description: |
     List of Username and Password pairs that have access to the sign urls. Cloud Controller must use one of these to access the bits-service via HTTP Basic Auth.
     Example:
       signer_users:
       - username: user1
         password: password1
       - username: user2
         password: password2

  bits-service.buildpacks.directory_key:
    description: "Directory (bucket) used to store buildpack blobs."
    default: "buildpacks"
  bits-service.buildpacks.blobstore_type:
    description: "The type of blobstore backing to use. Valid values: ['fog', 'webdav']"
    default: "fog"
  bits-service.buildpacks.webdav_config.public_endpoint:
    description: "The location of the webdav server eg: https://blobstore.com"
    default: ""
  bits-service.buildpacks.webdav_config.private_endpoint:
    description: "The location of the webdav server eg: https://blobstore.internal"
    default: "https://blobstore.service.cf.internal"
  bits-service.buildpacks.webdav_config.username:
    description: "The basic auth user that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.buildpacks.webdav_config.password:
    description: "The basic auth password that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.buildpacks.webdav_config.ca_cert:
    description: "The ca cert to use when communicating with webdav"
    default: ""
  bits-service.buildpacks.fog_connection:
    description: "Fog connection properties."
    default: null

  bits-service.droplets.directory_key:
    description: "Directory (bucket) used to store droplet blobs."
    default: "cc-droplets"
  bits-service.droplets.fog_connection:
    description: "Fog connection properties."
    default: null
  bits-service.droplets.blobstore_type:
    description: "The type of blobstore backing to use. Valid values: ['fog', 'webdav']"
    default: "fog"
  bits-service.droplets.webdav_config.public_endpoint:
    description: "The location of the webdav server eg: https://blobstore.com"
    default: ""
  bits-service.droplets.webdav_config.private_endpoint:
    description: "The location of the webdav server eg: https://blobstore.internal"
    default: "https://blobstore.service.cf.internal"
  bits-service.droplets.webdav_config.username:
    description: "The basic auth user that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.droplets.webdav_config.password:
    description: "The basic auth password that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.droplets.webdav_config.ca_cert:
    description: "The ca cert to use when communicating with webdav"
    default: ""

  bits-service.packages.directory_key:
    description: "Directory (bucket) used to store package blobs."
    default: "cc-packages"
  bits-service.packages.fog_connection:
    description: "Fog connection properties."
    default: null
  bits-service.packages.blobstore_type:
    description: "The type of blobstore backing to use. Valid values: ['fog', 'webdav']"
    default: "fog"
  bits-service.packages.webdav_config.public_endpoint:
    description: "The location of the webdav server eg: https://blobstore.com"
    default: ""
  bits-service.packages.webdav_config.private_endpoint:
    description: "The location of the webdav server eg: https://blobstore.internal"
    default: "https://blobstore.service.cf.internal"
  bits-service.packages.webdav_config.username:
    description: "The basic auth user that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.packages.webdav_config.password:
    description: "The basic auth password that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.packages.webdav_config.ca_cert:
    description: "The ca cert to use when communicating with webdav"
    default: ""

  bits-service.app_stash.directory_key:
    description: "Directory (bucket) used to store app stash blobs."
    default: "app_stash"
  bits-service.app_stash.fog_connection:
    description: "Fog connection properties."
    default: null
  bits-service.app_stash.blobstore_type:
    description: "The type of blobstore backing to use. Valid values: ['fog', 'webdav']"
    default: "fog"
  bits-service.app_stash.webdav_config.public_endpoint:
    description: "The location of the webdav server eg: https://blobstore.com"
    default: ""
  bits-service.app_stash.webdav_config.private_endpoint:
    description: "The location of the webdav server eg: https://blobstore.internal"
    default: "https://blobstore.service.cf.internal"
  bits-service.app_stash.webdav_config.username:
    description: "The basic auth user that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.app_stash.webdav_config.password:
    description: "The basic auth password that CC uses to connect to the admin endpoint on webdav"
    default: ""
  bits-service.app_stash.webdav_config.ca_cert:
    description: "The ca cert to use when communicating with webdav"
    default: ""

  bits-service.max_body_size:
    default: "1536M"
    description: "Maximum body size for nginx"

  bits-service.logging.level:
    default: "debug"
    description: "Log level for bits-service. See Steno logger for details."
  bits-service.logging.max_retries:
    default: 1
    description: "Number of times to retry if a write to the log file fails. See Steno logger for details."

  bits-service.nginx.access_log_destination:
    description: "Nginx access log destination. Can be used to route access logs to a file, syslog, or a memory buffer."
    default: "/var/vcap/sys/log/nginx_bits/nginx.access.log"
  bits-service.nginx.access_log_format:
    description: "Nginx log format string to use when writing to the access log."
    default: >
      $host - [$time_local] "$request" $status $bytes_sent "$http_referer" "$http_user_agent"
      $proxy_add_x_forwarded_for vcap_request_id:$upstream_http_x_vcap_request_id response_time:$upstream_response_time
  bits-service.nginx.error_log_destination:
    description: "Nginx error log destination. Can be used to route error logs to a file, syslog, or a memory buffer."
    default: "/var/vcap/sys/log/nginx_bits/nginx.error.log"
  bits-service.nginx.error_log_level:
    description: "The lowest severity nginx log level to capture in the error log."
    default: error
