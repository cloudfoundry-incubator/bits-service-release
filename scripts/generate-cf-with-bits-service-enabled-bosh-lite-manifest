#!/bin/bash -e

BLOBSTORE_TYPE=${1}
SIZE_LIMITS=${2}

if [ -z "$BLOBSTORE_TYPE" ]; then
  >&2 echo "Please provide a BLOBSTORE_TYPE {local,s3,webdav}"
  exit 1
fi

cd $(dirname $0)/../

mkdir -p deployments

cf_yml=../cf-release/bosh-lite/deployments/cf.yml

if [ ! -f "$cf_yml" ]; then
  echo "Could not find $cf_yml. Consider running ../cf-release/scripts/generate-bosh-lite-dev-manifest to create it."
  exit 1
fi

templates="
  ./templates/bits-service-from-ci.yml
  ./templates/cc-blobstore-properties.yml
  ./templates/bits-service-signing-properties.yml
  ./templates/director_uuid.yml
  ./templates/acceptance_test_properties.yml
  ./templates/enable-bits.yml
  ./templates/bits-network-bosh-lite.yml
  ./templates/mutual_tls.yml
  ./templates/bits_service_tests.yml
"

if [ "${SIZE_LIMITS}" == "--size-limits" ]; then
  echo "Including size limits for blobstore uploads"
  templates="${templates}
    ./templates/body-size-stub.yml
  "
else
  echo "Skipping size limits for blobstore uploads"
fi

if [ "${BLOBSTORE_TYPE}" == "webdav" ]; then
  templates="${templates}
    ./templates/webdav.yml
    ./templates/webdav-blobstore-support.yml
  "
else
  templates="${templates}
    ./templates/${BLOBSTORE_TYPE}.yml
  "
fi

spruce merge "$cf_yml" ${templates} \
  > deployments/cf-with-bits-service-enabled.yml

bosh deployment deployments/cf-with-bits-service-enabled.yml
